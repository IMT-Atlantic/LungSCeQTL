# ç­›é€‰sigGenes
import pandas as pd
import os
from datetime import datetime

# é…ç½®ï¼šæ ¹æ®ä½ çš„å‡è¯´å®šä¹‰ç›®æ ‡åŸºå› å’Œç­›é€‰é€»è¾‘
targets = {
    "ATG7":  {"file": "LungSCeQTL_Result/spiderResult/ATG7_MP.xlsx",  "axis": "Smad4 Axis",  "expected_beta": "Negative (If disrupting Activator)"},
    "BNIP3": {"file": "LungSCeQTL_Result/spiderResult/BNIP3_MP.xlsx", "axis": "Smad4 Axis",  "expected_beta": "Negative (If disrupting Activator)"},
    "PINK1": {"file": "LungSCeQTL_Result/spiderResult/PINK1_MP.xlsx", "axis": "Ddit3 Axis",  "expected_beta": "Negative (If enhancing Repressor)"},
    "ALKBH4":{"file": "LungSCeQTL_Result/spiderResult/ALKBH4_MP.xlsx","axis": "Nfatc Axis",  "expected_beta": "Negative (If disrupting Activator)"}
}

# è®¾å®šæ˜¾è‘—æ€§é˜ˆå€¼
P_VALUE_THRESHOLD = 0.05

# åˆ›å»ºä¿å­˜ç»“æœçš„ç›®å½•
output_dir = "LungSCeQTL_Result/significant_results"
os.makedirs(output_dir, exist_ok=True)

def process_lung_eqtl(target_name, config):
    file_path = config["file"]
    if not os.path.exists(file_path):
        print(f"âš ï¸ æ–‡ä»¶æœªæ‰¾åˆ°: {file_path}ï¼Œè·³è¿‡ã€‚")
        return None
    
    print(f"æ­£åœ¨å¤„ç† {target_name} ({config['axis']})...")
    
    try:
        # è¯»å– Excel
        df = pd.read_excel(file_path)
        
        # 1. åŸºç¡€è¿‡æ»¤ï¼šç­›é€‰æ˜¾è‘—çš„ SNPs
        sig_df = df[df['P_value'] < P_VALUE_THRESHOLD].copy()
        
        if sig_df.empty:
            print(f"  -> åœ¨ P < {P_VALUE_THRESHOLD} ä¸‹æ— æ˜¾è‘— SNPã€‚")
            
            # å³ä½¿æ²¡æœ‰æ˜¾è‘—ç»“æœï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªç©ºçš„ DataFrame å¹¶ä¿å­˜
            sig_df = pd.DataFrame(columns=df.columns)
            sig_df['Effect_Direction'] = None
            sig_df['Analysis_Timestamp'] = None
        else:
            # 2. æ•´ç†å…³é”®ä¿¡æ¯
            sig_df['Effect_Direction'] = sig_df['Beta'].apply(lambda x: "Down-regulation" if x < 0 else "Up-regulation")
            
            # 3. æ’åºï¼šæŒ‰ På€¼ æœ€æ˜¾è‘—æ’åº
            sig_df = sig_df.sort_values(by='P_value')
            
            print(f"  -> æ‰¾åˆ° {len(sig_df)} ä¸ªæ˜¾è‘— SNPsã€‚")
            
            # æ˜¾ç¤ºå‰10ä¸ªç»“æœä¾›é¢„è§ˆ
            if len(sig_df) >= 10:
                preview_df = sig_df.head(10)[['SNP_ID', 'SNP_Position', 'OA', 'EA', 'Beta', 'P_value', 'Effect_Direction']]
                print(f"å‰ 10 ä¸ªæœ€æ˜¾è‘—çš„ç»“æœ:")
                print(preview_df.to_string(index=False))
            else:
                preview_df = sig_df[['SNP_ID', 'SNP_Position', 'OA', 'EA', 'Beta', 'P_value', 'Effect_Direction']]
                print(f"æ‰€æœ‰ {len(sig_df)} ä¸ªæ˜¾è‘—ç»“æœ:")
                print(preview_df.to_string(index=False))
        
        # 4. æ·»åŠ å…ƒæ•°æ®å’Œç»Ÿè®¡ä¿¡æ¯
        sig_df['Analysis_Timestamp'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        sig_df['Target_Gene'] = target_name
        sig_df['Axis'] = config['axis']
        sig_df['Expected_Beta'] = config['expected_beta']
        sig_df['P_Value_Threshold'] = P_VALUE_THRESHOLD
        sig_df['Original_Rows'] = len(df)
        sig_df['Significant_Rows'] = len(sig_df)
        
        # 5. ä¿å­˜æ¯ä¸ªåŸºå› çš„å®Œæ•´ç»“æœåˆ°å•ç‹¬çš„æ–‡ä»¶
        output_file = os.path.join(output_dir, f"{target_name}_significant_results.xlsx")
        
        # åˆ›å»ºä¸€ä¸ªExcel writerï¼ŒåŒ…å«ä¸¤ä¸ªå·¥ä½œè¡¨ï¼šæ‰€æœ‰ç»“æœå’Œç»Ÿè®¡æ‘˜è¦
        with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
            # å·¥ä½œè¡¨1: æ‰€æœ‰æ˜¾è‘—ç»“æœ
            sig_df.to_excel(writer, sheet_name='All_Significant_SNPs', index=False)
            
            # å·¥ä½œè¡¨2: ç»Ÿè®¡æ‘˜è¦
            summary_data = {
                'Statistic': [
                    'Target Gene', 'Axis', 'Expected Beta', 
                    'P-value Threshold', 'Total SNPs in Original File',
                    'Significant SNPs Found', 'Analysis Timestamp'
                ],
                'Value': [
                    target_name, config['axis'], config['expected_beta'],
                    P_VALUE_THRESHOLD, len(df), len(sig_df),
                    datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                ]
            }
            summary_df = pd.DataFrame(summary_data)
            summary_df.to_excel(writer, sheet_name='Summary', index=False)
            
            # å·¥ä½œè¡¨3: æŒ‰æ–¹å‘åˆ†ç±»çš„ç»Ÿè®¡
            if 'Effect_Direction' in sig_df.columns and not sig_df.empty:
                direction_counts = sig_df['Effect_Direction'].value_counts()
                direction_df = pd.DataFrame({
                    'Direction': direction_counts.index,
                    'Count': direction_counts.values,
                    'Percentage': (direction_counts.values / len(sig_df) * 100).round(2)
                })
                direction_df.to_excel(writer, sheet_name='Direction_Stats', index=False)
        
        print(f"  âœ… ç»“æœå·²ä¿å­˜åˆ°: {output_file}")
        print(f"     æ–‡ä»¶åŒ…å«: {len(sig_df)} ä¸ªæ˜¾è‘—SNPs")
        print("-" * 60)
        
        return sig_df
        
    except Exception as e:
        print(f"  -> å¤„ç†å‡ºé”™: {e}")
        return None

def create_summary_report(all_results):
    """åˆ›å»ºæ‰€æœ‰åŸºå› çš„æ±‡æ€»æŠ¥å‘Š"""
    if not all_results:
        print("æ²¡æœ‰æœ‰æ•ˆçš„ç»“æœå¯ä»¥æ±‡æ€»ã€‚")
        return
    
    # æ”¶é›†æ±‡æ€»ä¿¡æ¯
    summary_list = []
    all_significant_snps = []
    
    for gene, df in all_results.items():
        if not df.empty:
            # ç»Ÿè®¡ä¿¡æ¯
            summary_list.append({
                'Gene': gene,
                'Axis': df['Axis'].iloc[0] if 'Axis' in df.columns else targets[gene]['axis'],
                'Total_SNPs': df['Original_Rows'].iloc[0] if 'Original_Rows' in df.columns else 'N/A',
                'Significant_SNPs': len(df),
                'Down_regulated': len(df[df['Effect_Direction'] == 'Down-regulation']) if 'Effect_Direction' in df.columns else 0,
                'Up_regulated': len(df[df['Effect_Direction'] == 'Up-regulation']) if 'Effect_Direction' in df.columns else 0,
                'Min_P_value': df['P_value'].min() if 'P_value' in df.columns and not df.empty else 'N/A',
                'Mean_Beta': df['Beta'].mean() if 'Beta' in df.columns and not df.empty else 'N/A',
                'File_Saved': f"{gene}_significant_results.xlsx"
            })
            
            # æ”¶é›†æ‰€æœ‰æ˜¾è‘—çš„SNPsç”¨äºæ±‡æ€»æ–‡ä»¶
            df_for_summary = df.copy()
            df_for_summary['Source_Gene'] = gene
            all_significant_snps.append(df_for_summary)
    
    # åˆ›å»ºæ±‡æ€»æ–‡ä»¶
    if summary_list:
        summary_df = pd.DataFrame(summary_list)
        all_snps_df = pd.concat(all_significant_snps, ignore_index=True) if all_significant_snps else pd.DataFrame()
        
        summary_file = os.path.join(output_dir, "ALL_GENES_SUMMARY.xlsx")
        
        with pd.ExcelWriter(summary_file, engine='openpyxl') as writer:
            # å·¥ä½œè¡¨1: å„åŸºå› ç»Ÿè®¡æ‘˜è¦
            summary_df.to_excel(writer, sheet_name='Gene_Summary', index=False)
            
            # å·¥ä½œè¡¨2: æ‰€æœ‰æ˜¾è‘—SNPsçš„æ±‡æ€»
            if not all_snps_df.empty:
                # æŒ‰På€¼æ’åº
                all_snps_df = all_snps_df.sort_values(by='P_value')
                all_snps_df.to_excel(writer, sheet_name='All_Significant_SNPs', index=False)
            
            # å·¥ä½œè¡¨3: åˆ†æå‚æ•°
            params_df = pd.DataFrame({
                'Parameter': ['Analysis Date', 'P-value Threshold', 'Total Genes Analyzed'],
                'Value': [datetime.now().strftime("%Y-%m-%d %H:%M:%S"), 
                         P_VALUE_THRESHOLD, len(targets)]
            })
            params_df.to_excel(writer, sheet_name='Analysis_Parameters', index=False)
        
        print(f"\n" + "="*60)
        print(f"ğŸ“Š æ±‡æ€»æŠ¥å‘Šå·²ç”Ÿæˆ: {summary_file}")
        print(f"   å…±åˆ†æ {len(summary_list)} ä¸ªåŸºå› ï¼Œæ‰¾åˆ° {len(all_snps_df)} ä¸ªæ˜¾è‘—SNPs")
        print("="*60)
        
        # æ‰“å°æ±‡æ€»è¡¨æ ¼
        print("\nå„åŸºå› ç»“æœæ‘˜è¦:")
        display_summary = summary_df[['Gene', 'Axis', 'Significant_SNPs', 
                                     'Down_regulated', 'Up_regulated', 'Min_P_value']]
        print(display_summary.to_string(index=False))

# æ‰§è¡Œä¸»ç¨‹åº
print("å¼€å§‹åˆ†æ eQTL æ•°æ®...")
print(f"ä¿å­˜ç›®å½•: {output_dir}")
print("-" * 60)

all_results = {}
for gene, config in targets.items():
    res = process_lung_eqtl(gene, config)
    if res is not None:
        all_results[gene] = res

# åˆ›å»ºæ±‡æ€»æŠ¥å‘Š
create_summary_report(all_results)

print(f"\nâœ… åˆ†æå®Œæˆï¼æ‰€æœ‰ç»“æœå·²ä¿å­˜åˆ°ç›®å½•: {output_dir}")
print("   æ¯ä¸ªåŸºå› çš„ç»“æœä¿å­˜åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶ç”Ÿæˆäº†æ±‡æ€»æŠ¥å‘Šã€‚")
